<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Relat√≥rio de Execu√ß√£o</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom right, #1e1f26, #343746);
      color: #ecf0f1;
      overflow: hidden;
    }

    header {
      background: linear-gradient(90deg, #fdd39b, #ff9100);
      color: white;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    header img {
      height: 42px;
    }

    header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 26px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 40px 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    select {
      background-color: #2d3436;
      color: #ecf0f1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      min-width: 200px;
      font-size: 15px;
    }

    .btn-export, #btnBuscar {
      background: linear-gradient(90deg, #f39c12, #f1c40f);
      color: #1e1f26;
      padding: 10px 20px;
      font-weight: bold;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 15px;
      transition: transform 0.2s, box-shadow 0.3s;
    }

    .btn-export:hover, #btnBuscar:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(243, 156, 18, 0.4);
    }

    .container {
      padding: 0 40px 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    input[type="file"] {
      background-color: #2d3436;
      color: #ecf0f1;
      padding: 12px 18px;
      border-radius: 8px;
      border: none;
      margin: 15px 0 20px;
      cursor: pointer;
    }

    .tabela-wrapper {
      background-color: #1e1f26;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      width: 100%;
      height: 500px;
      overflow-y: auto;
      overflow-x: auto;
      padding: 20px;
    }

    table {
      border-collapse: collapse;
      background: #2c3e50;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      width: max-content;
    }

    th, td {
      padding: 14px;
      border: 1px solid #34495e;
      text-align: center;
      font-size: 14px;
      color: #ecf0f1;
      white-space: nowrap;
    }

    th {
      background: #34495e;
      font-weight: 600;
    }

    .executado { background-color: #27ae60; }
    .nao-executado { background-color: #c0392b; }
    .sem-dado { background-color: #7f8c8d; }

    @media (max-width: 768px) {
      th, td {
        font-size: 12px;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo ap 03.png" alt="Logo">
    <h1>RELAT√ìRIO DE VISITAS CONSOLIDADAS</h1>
  </header>

  <div class="top-bar">
  <div style="display: flex; gap: 10px; align-items: center;">
    <select id="filtroAtividades" size="1">
      <option value="TODAS">Todas as atividades</option>
    </select>
    <button id="btnBuscar">üîç Buscar</button>
  </div>
  <button class="btn-export" id="btnExport" style="display: none;">‚¨á Exportar Relat√≥rio</button>
</div>
  </div>

  <div class="container">
    <input type="file" id="fileInput" />
    <div class="tabela-wrapper">
      <div id="tabelaContainer" style="min-width: 700px;"></div>
    </div>
  </div>

  <script>
    const dadosOrganizados = {};
    let datas = [];

    function excelDateParaISO(serial) {
      const excelEpoch = new Date(1899, 11, 30);
      return new Date(excelEpoch.getTime() + serial * 86400000).toISOString().slice(0,10);
    }

    document.getElementById("fileInput").addEventListener("change", e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const aba = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(aba, { defval: "" });
        montarRelatorio(json);
      };
      reader.readAsArrayBuffer(file);
    });

    function montarRelatorio(dados) {
      Object.keys(dadosOrganizados).forEach(k => delete dadosOrganizados[k]);
      const datasSet = new Set();
      const atividadesSet = new Set();

      dados.forEach(item => {
        let rawData = item["Data"];
        let dataFormatada = "";
        if (typeof rawData === "number") {
          dataFormatada = excelDateParaISO(rawData);
        } else if (typeof rawData === "string") {
          const data = new Date(rawData);
          if (!isNaN(data)) dataFormatada = data.toISOString().slice(0,10);
        }

        const local = item["Local"]?.trim() || "Local n√£o informado";
        const promotor = item["Promotor"]?.trim() || "Promotor n√£o informado";
        const atividade = item["Atividade"]?.trim() || "Atividade n√£o informada";
        const executado = item["Executado"].toString().toLowerCase() === "sim" ? 1 : 0;

        if (dataFormatada) {
          datasSet.add(dataFormatada);
          atividadesSet.add(atividade);
          const chave = `${local}__${promotor}__${atividade}`;
          if (!dadosOrganizados[chave]) {
            dadosOrganizados[chave] = { Local: local, Promotor: promotor, Atividade: atividade, datas: {}, total: 0 };
          }
          dadosOrganizados[chave].datas[dataFormatada] = executado;
          dadosOrganizados[chave].total += executado;
        }
      });

      datas = Array.from(datasSet).sort();

      const filtro = document.getElementById("filtroAtividades");
      filtro.innerHTML = '<option value="TODAS">Todas as atividades</option>';
      [...atividadesSet].sort().forEach(atividade => {
        const op = document.createElement("option");
        op.value = atividade;
        op.textContent = atividade;
        filtro.appendChild(op);
      });

      document.getElementById("btnExport").style.display = "inline-block";
      document.getElementById("btnBuscar").click(); // mostrar tudo por padr√£o
    }

    document.getElementById("btnBuscar").addEventListener("click", () => {
      const selecionada = document.getElementById("filtroAtividades").value;
      const exportarTodas = selecionada === "TODAS";

            const container = document.getElementById("tabelaContainer");
      const tabela = document.createElement("table");

      let header = "<tr><th>Local</th><th>Promotor</th><th>Atividade</th>";
      header += datas.map(d => `<th>${d}</th>`).join("") + "<th>Total</th></tr>";

      let linhas = "";

      Object.values(dadosOrganizados).forEach(item => {
        if (exportarTodas || item.Atividade === selecionada) {
          let linha = `<td>${item.Local}</td><td>${item.Promotor}</td><td>${item.Atividade}</td>`;
          datas.forEach(d => {
            const valor = item.datas[d];
            if (valor === 1) linha += '<td class="executado">1</td>';
            else if (valor === 0) linha += '<td class="nao-executado">0</td>';
            else linha += '<td class="sem-dado">-</td>';
          });
          linha += `<td>${item.total}</td>`;
          linhas += `<tr>${linha}</tr>`;
        }
      });

      tabela.innerHTML = header + linhas;
      container.innerHTML = "";
      container.appendChild(tabela);
    });

    document.getElementById("btnExport").addEventListener("click", async () => {
      const selecionada = document.getElementById("filtroAtividades").value;
      const exportarTodas = selecionada === "TODAS";

      const tabela = document.querySelector("table");
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet("Relat√≥rio");

      const linhas = [];
      tabela.querySelectorAll("tr").forEach(tr => {
        const linha = [];
        tr.querySelectorAll("th, td").forEach(cell => {
          linha.push(cell.innerText);
        });
        linhas.push(linha);
      });

      linhas.forEach((linha, i) => {
        const atividade = linha[2];
        if (i === 0 || exportarTodas || atividade === selecionada) {
          const row = ws.addRow(linha);
          row.alignment = { vertical: "middle", horizontal: "center" };

          linha.forEach((valor, j) => {
            const cell = row.getCell(j + 1);
            cell.border = {
              top: { style: "thin" },
              left: { style: "thin" },
              bottom: { style: "thin" },
              right: { style: "thin" }
            };

            if (i === 0) {
              cell.font = { bold: true, color: { argb: "FFFFFF" } };
              cell.fill = {
                type: "pattern",
                pattern: "solid",
                fgColor: { argb: "000000" }
              };
            } else {
              if (valor === "1") {
                cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "C6EFCE" } };
              } else if (valor === "0") {
                cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFC7CE" } };
              } else if (valor === "-") {
                cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "F2F2F2" } };
              }
              cell.font = { color: { argb: "000000" } };
            }
          });
        }
      });

      const buffer = await wb.xlsx.writeBuffer();
      const nomeArquivo = `relatorio_${(exportarTodas ? "TODAS" : selecionada).replace(/\s+/g, "_")}.xlsx`;
saveAs(new Blob([buffer]), nomeArquivo);
    });
  </script>
</body>
</html>